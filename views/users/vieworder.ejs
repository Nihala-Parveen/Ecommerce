<%- include('../layouts/header.ejs') %>
<section class="p-5">
<div class="container">
    <nav aria-label="breadcrumb" style="background-color: white;">
        <ol class="breadcrumb mt-3">
            <li class="breadcrumb-item"><a href="/home">Home</a></li>
            <li class="breadcrumb-item"><a href="/orders">My Orders</a></li>
            <li class="breadcrumb-item active" aria-current="page"><%= orders._id %></li>
        </ol>
    </nav>
    
        <div class="rounded shadow-sm p-3" style="border: 1px solid #e1d9d9;">
            <h4>Delivery Address</h4>
            <h5><%= orders.user.name %></h5>
            <p><%= orders.address.buildingName %> , <%= orders.address.city %></p>
            <p><%= orders.address.district %> , <%= orders.address.ZIPcode %></p>
            <p>Phone Number : <%= orders.user.mobile %></p>
            <p><%=  %></p>
        </div>

        <div class="rounded shadow-sm p-3 mt-4" style="border: 1px solid #e1d9d9;">
            <h4>Items in this order</h4>
            <table class="table mt-5">
                <thead>
                    <tr>
                        <th scope="col">Product Image</th>
                        <th scope="col">Product Name</th>
                        <th scope="col">Quantity</th>
                        <th scope="col">Price</th>
                        <th scope="col">Status</th>
                        <th scope="col"></th>
                    </tr>
                </thead>
                <tbody>
                    <% orders.products.forEach((product) => { %>
                        <tr>
                            <td><img src="/uploads/<%= product.productId.images[0] %>" alt="img1" height="100px" width="100px"></td>
                            <td><%= product.productId.name %></td>
                            <td><%= product.quantity %></td>
                            <td><%= product.price * product.quantity %></td>
                            <td><%= product.status %></td>
                            <% if (!( product.status === "Cancelled" || product.status === "Delivered")) { %>
                                <td class="text-danger">
                                    <a href="#" onclick="showCancelConfirmationModal('<%= orders._id %>', '<%= product._id %>')" class="text-danger">Cancel Order</a>
                                </td>
                            <% } else if(product.status === "Delivered") { %>
                                <td class="text-danger">
                                    <a href="#"  class="text-danger h6">Return Order</a>
                                </td>
                            <% } %>
                        </tr>
                    <% }) %>
                </tbody>
            </table>
            
            <p>Total Amount: <%= orders.amount %></p>
            <p>Payment Method : <%= orders.payment %></p>
            <p>Status: <%= orders.status %></p>
        </div>
    
</div>
</section>
<!-- Confirmation Modal for Order Cancellation -->
<div class="modal fade" id="cancelConfirmationModal" tabindex="-1" role="dialog" aria-labelledby="cancelConfirmationModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="cancelConfirmationModalLabel">Confirm Order Cancellation</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                Are you sure you want to cancel this order?
            </div>
            <div class="modal-footer">
                <button type="button" class="genric-btn success-border" data-dismiss="modal">Cancel</button>
                <button type="button" class="genric-btn danger-border" id="cancelConfirmBtn">Cancel Order</button>
            </div>
        </div>
    </div>
</div>

<script>
    function showCancelConfirmationModal(orderId, productId) {
        
        $('#cancelConfirmationModal').modal('show');
        console.log('orderIdejs:', orderId);
console.log('productIdejs:', productId);
    
        document.getElementById('cancelConfirmBtn').onclick = async function () {
            try {
                const response = await fetch(`/cancelProduct?orderId=${orderId}&itemId=${productId}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                });
    
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
    
                const data = await response.json();
    
                window.location.href = '/vieworder';
            } catch (error) {
                console.error('Error:', error);
            }
        };
    }
    </script>
<%- include('../layouts/footer.ejs') %>
